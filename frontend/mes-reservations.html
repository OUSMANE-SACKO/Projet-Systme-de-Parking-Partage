<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxawCar - Mes R√©servations</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar-rounded">
    <div class="nav-left">
      <span class="logo-icon">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <polygon points="20,5 35,13 35,27 20,35 5,27 5,13" fill="#8e24aa"/>
          <circle cx="20" cy="20" r="7" fill="#fff" fill-opacity="0.92"/>
          <circle cx="20" cy="20" r="3.5" fill="#8e24aa"/>
        </svg>
      </span>
      <span class="logo-text">TaxawCar</span>
    </div>
    <ul class="nav-center">
      <li><a href="dashboard.html">Accueil</a></li>
      <li><a href="reserver.html">R√©server</a></li>
      <li><a href="mes-reservations.html" class="active">Mes R√©servations</a></li>
      <li><a href="mes-stationnements.html">Mes Stationnements</a></li>
      <li><a href="abonnement.html">Abonnements</a></li>
    </ul>
    <div class="nav-right">
      <span class="user-info">
        <span class="user-avatar">üë§</span>
        <span class="user-name" id="nav-user-name">Utilisateur</span>
      </span>
      <button class="logout-btn" onclick="logout()">D√©connexion</button>
    </div>
  </nav>

    <main class="container">
        <h1>üìÖ Mes R√©servations</h1>
        
        <div id="user-info" class="info-card">
            <p>Bienvenue, <span id="user-name">Utilisateur</span></p>
        </div>

        <section class="reservations-section">
            <div class="filters">
                <select id="status-filter" onchange="filterReservations()">
                    <option value="all">Toutes les r√©servations</option>
                    <option value="active">En cours</option>
                    <option value="pending">√Ä venir</option>
                    <option value="completed">Termin√©es</option>
                    <option value="cancelled">Annul√©es</option>
                </select>
            </div>

            <div id="reservations-list" class="reservations-grid">
                <p>Chargement...</p>
            </div>
        </section>

        <!-- Modal Facture -->
        <div id="invoice-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeInvoiceModal()">&times;</span>
                <h2>üìÑ Facture</h2>
                <div id="invoice-content"></div>
                <button class="btn-primary" onclick="printInvoice()">üñ®Ô∏è Imprimer</button>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 TaxawCar - Syst√®me de parking partag√©</p>
    </footer>

    <script src="api.js"></script>
    <script>
        let allReservations = [];

        document.addEventListener('DOMContentLoaded', () => {
            const user = api.getCurrentUser();
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            const displayName = user.name || user.forename || user.email;
            document.getElementById('user-name').textContent = displayName;
            const navName = document.getElementById('nav-user-name');
            if (navName) navName.textContent = displayName;
            loadReservations();
        });

        function logout() {
            api.logout();
            window.location.href = 'index.html';
        }

        async function loadReservations() {
            const container = document.getElementById('reservations-list');
            
            try {
                const result = await api.getUserReservations();
                
                if (!result.success) {
                    container.innerHTML = `<p class="error">Erreur: ${result.error || result.message}</p>`;
                    return;
                }
                
                allReservations = result.reservations || [];
                displayReservations(allReservations);
                
            } catch (error) {
                container.innerHTML = '<p class="error">Erreur de connexion au serveur.</p>';
            }
        }

        function filterReservations() {
            const filter = document.getElementById('status-filter').value;
            
            if (filter === 'all') {
                displayReservations(allReservations);
            } else {
                const filtered = allReservations.filter(r => r.status === filter);
                displayReservations(filtered);
            }
        }

        function displayReservations(reservations) {
            const container = document.getElementById('reservations-list');
            
            if (!reservations.length) {
                container.innerHTML = '<p>Aucune r√©servation trouv√©e.</p>';
                return;
            }
            
            container.innerHTML = reservations.map(r => `
                <div class="reservation-card status-${r.status}">
                    <div class="reservation-header">
                        <h3>${r.parkingName || 'Parking'}</h3>
                        <span class="status-badge ${r.status}">${getStatusLabel(r.status)}</span>
                    </div>
                    <p class="reservation-address">üìç ${r.parkingAddress || 'Adresse non disponible'}</p>
                    <div class="reservation-times">
                        <p><strong>D√©but:</strong> ${formatDate(r.startTime)}</p>
                        <p><strong>Fin:</strong> ${formatDate(r.endTime)}</p>
                    </div>
                    <div class="reservation-price">
                        <span class="price">${r.totalPrice || '0.00'}‚Ç¨</span>
                    </div>
                    <div class="reservation-actions">
                        <button class="btn-secondary" onclick="showInvoice('${r.id}')">üìÑ Facture</button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ √Ä venir',
                'active': 'üü¢ En cours',
                'completed': '‚úÖ Termin√©e',
                'cancelled': '‚ùå Annul√©e',
                'past': 'üìú Pass√©e'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleString('fr-FR', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function showInvoice(reservationId) {
            const modal = document.getElementById('invoice-modal');
            const content = document.getElementById('invoice-content');
            
            content.innerHTML = '<p>Chargement de la facture...</p>';
            modal.style.display = 'flex';
            
            try {
                const result = await api.getReservationInvoice(reservationId, 'html');
                
                if (result.success) {
                    content.innerHTML = result.html || generateInvoiceHtml(result.invoice);
                } else {
                    content.innerHTML = `<p class="error">Erreur: ${result.error || result.message}</p>`;
                }
            } catch (error) {
                content.innerHTML = '<p class="error">Erreur lors du chargement de la facture.</p>';
            }
        }

        function generateInvoiceHtml(invoice) {
            if (!invoice) return '<p>Facture non disponible</p>';
            
            return `
                <div class="invoice">
                    <h3>Facture ${invoice.invoiceNumber}</h3>
                    <p>Date: ${invoice.date}</p>
                    <hr>
                    <h4>Client</h4>
                    <p>${invoice.customer?.name}<br>${invoice.customer?.email}</p>
                    <h4>Parking</h4>
                    <p>${invoice.parking?.name}<br>${invoice.parking?.address}</p>
                    <h4>D√©tails</h4>
                    <p>Du: ${invoice.reservation?.startTime}<br>
                       Au: ${invoice.reservation?.endTime}<br>
                       Dur√©e: ${invoice.reservation?.duration}</p>
                    <hr>
                    <h3 class="total">Total: ${invoice.amount} ${invoice.currency}</h3>
                </div>
            `;
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        function printInvoice() {
            const content = document.getElementById('invoice-content').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Facture TaxawCar</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1, h2, h3 { color: #8e24aa; }
                    hr { border: 1px solid #ddd; margin: 15px 0; }
                    .total { text-align: right; font-size: 1.5em; }
                </style>
                </head>
                <body>${content}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Fermer le modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('invoice-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
